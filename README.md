# ZenRock http://zenrock.tv
ZenRockはTvRockと連携して全番組自動録画を実現するためのソフトウェアです。


このソフトウェアは次世代テレビ研究のためのTVコンテンツの活用・分析用に開発されました。

## 主要機能
* 地デジを全自動で全番組録画
	* ※録画する放送局の数に応じて地デジチューナーが必要になります
* 録画ファイルに対するメタ情報（番組情報・サムネイル）を自動で付加
* ブラウザから録画した番組一覧を閲覧・検索
	* 番組の予約を担当するプログラム（後述する tvbooker.exe）を使わなければ、ユーザが手動で録画した番組に対してメタ情報を付加し、ブラウザからその一覧を閲覧・検索することもできます

## 使い方
まずはTvRockのWeb番組表から番組を録画できるようにして下さい（地デジチューナやTvRock, RecTest, TvTestの詳しい設定方法については他のWebサイトを参考にして下さい）。


+ TvRockで以下の項目を設定します
	* 「録画基本設定」→「ファイル名置換フォーマット」を「@CH@YY@MM@DD@SH@SM@SS」に
		* 録画した番組がずれる場合は「予約登録デフォルト値」を調整します
		* 画像
	* 「チューナー」→「録画フォルダ」をこのシステム専用の録画用ディレクトリにします
		* 以降このディレクトリをRecordDirPathと呼びます
		* 画像
+ setting.jsonを設定します
  + 録画用ディレクトリにweb.zipを解凍し、RecordDirPath/web/となるように配置します。
+ start.batを起動します
	+ もし設定エラーがあるとシステムを起動せずに終了します。エラーメッセージにしたがって、setting.json を修正して下さい。
	+ 全録せずに見たい番組だけを録画したい場合は、start.bat から「start tvbooker.exe」の1行を除いて起動して下さい。
+ 5つ（tvbookerを使わない場合は4つ）のウィンドウが開くので、しばらく見守ります。エラーが起きていなければ、全てのプログラムが動作し続けます。
+ RecordDirPath に all.json が出力されていれば、Webインタフェースを利用可能です。http://localhost:10080/ui または http://[LAN内でのIPアドレス]:10080/ui（他のPCからもアクセス可能です）にアクセスし、録画した番組の視聴・検索を楽しんで下さい。


### 依存ソフトウェア
* TvRock
	* Ver 0.9t8で動作確認
* RecTest
* ffmpeg
  * できるだけ最新のバージョンを使って下さい
* ImageMagick(convert)

## ソフトウェア構成
（モジュール図）


## 仕様
放送された番組を一意に特定するために次の番組IDを定義します。
* 番組ID
	* <放送局のサービスID(4ケタ)><放送年(4ケタ)><月(2ケタ)><日(2ケタ)><時(2ケタ)><分(2ケタ)><秒(2ケタ)>
	* 例：102420130702165500, 104020130702115500 など

### check_setting.exe
setting.json の設定が正しいかどうかを確認するためのプログラムです。
TvRock のWeb番組表が有効になっていない場合にもエラーを出力します。
これのソースコードは check_setting.rb として同梱してあります。

### start.bat
check_setting.exe が終了コード0（エラーなし）で終了した場合に、
以降のプログラム（main.exe, createthumbs.exe, tvbooker.exe, httpserver.exe, tvcollector.exe）を起動します。

### main.exe
30分に1回の周期で次の処理を繰り返します。
* RecordDirPath のあるドライブの使用容量が95%を超えた場合に、録画した番組を古いものから20件削除する
* 録画が完了したTSファイルにメタ情報取得可能であることを表す印をつける
* 録画番組のメタ情報を収集し、all.json としてまとめる

### createthumbnail.exe
30分に1回の周期で次の処理を繰り返します。
* 録画が完了したTSファイルからサムネイル画像を抽出
	* ffmpeg で番組開始10秒後のサムネイル画像を抽出する
	* 何らかの理由でサムネイル画像を取得できない場合は、番組名をGoogle画像検索して1番上にヒットした画像をダウンロード、ImageMagick の convert を使って 640x360 にリサイズする。

### tvbooker.exe
3時間に1回の周期で次の処理を繰り返します。
* TvRockのWeb番組表の全番組に対して「予約」ボタンを押す

### httpserver.exe
ネットワークアダプタが複数ある場合は選択を促すメッセージを表示する。
http://localhost:10080/ または http://[LAN内でのIPアドレス]:10080/ にてサービスを開始する。
（LAN内の他のPCからも操作可能）

* http://localhost:10080/hello
	* サーバの生存確認を行う。ZenRockの応用ソフトを実装する際に使う。
* http://localhost:10080/exec?cmd=getall
	* 録画した全ての番組のメタ情報を集約している all.json をダウンロードする。
* http://localhost:10080/exec?image=[番組ID]
	* 番組のサムネイル画像を取得する。
* http://localhost:10080/ui
	* 録画した全ての番組をサムネイル・番組説明とともに一覧で表示する。
* http://localhost:10080/ui?sid=[sid]&q=[検索ワード]
	* 放送局のサービスID(sid)と検索ワードにヒットする番組の一覧を表示する。
* http://localhost:10080/ui?watch=[番組ID]
	* サーバでVLCを起動し、該当する番組を再生する（現在はVLCのみに対応）。


### tvinfocollector.exe
30分に1回の周期で次の処理を繰り返します。
* 録画が完了した番組に対して、（プロジェクトが提供する）サーバにその番組情報を問い合わせ、json形式でダウンロードする。


## 動作実績
* Dell XPS 8500をベースにPLEX PX-W3PE×2, PLEX PX-Q3PE, 3TB SATA HDD×2（スパンボリュームとして運用）を追加したPCにて2012年6月～現在まで運用中
